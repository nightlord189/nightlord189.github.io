<!DOCTYPE html>
<html lang="ru">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Алексей Буравов">
    <meta name="description" content="https://nldevelop.com/">
    <meta name="keywords" content="blog,developer,software">

    <meta property="og:site_name" content="Алексей Буравов">
    <meta property="og:title" content="
  Сборка Golang-приложения в Docker - Алексей Буравов
">
    <meta property="og:description" content="Dockerfile, multistage и кэширование зависимостей">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nldevelop.com/ru/posts/go-docker/">
    <meta property="og:image" content="https://nldevelop.com/images/tn.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="https://nldevelop.com/ru/posts/go-docker/">
    <meta name="twitter:image" content="https://nldevelop.com/images/tn.png">

    <base href="https://nldevelop.com/ru/posts/go-docker/">
    <title>
  Сборка Golang-приложения в Docker - Алексей Буравов
</title>

    <link rel="canonical" href="https://nldevelop.com/ru/posts/go-docker/">
    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    
    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="/css/normalize.min.css">
    <link rel="stylesheet" href="/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    
      <link rel="alternate" href="https://nldevelop.com/ru/index.xml" type="application/rss+xml" title="Алексей Буравов">
      <link href="https://nldevelop.com/ru/index.xml" rel="feed" type="application/rss+xml" title="Алексей Буравов" />
    

    <meta name="generator" content="Hugo 0.75.1" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/ru/">Алексей Буравов</a>
    <input type="checkbox" id="menu-control"/>
    <label class="menu-mobile  float-right " for="menu-control">
      <span class="btn-mobile  float-right ">&#9776;</span>
      <ul class="navigation-list">
        
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://nldevelop.com/ru/about">О себе</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://nldevelop.com/ru/cv">Резюме</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://nldevelop.com/ru/posts">Блог</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://nldevelop.com/ru/contact">Контакты</a>
            </li>
          
        
        
          
          
          
            <li class= " mobile-menu-lang-separator-centered ">
              <hr />
            </li>
          
          
            
          
            
              
                
                  <li class="multilingual-separator">
                    <p>|</p>
                  </li>
                
                
              
              <li class="navigation-item  align-center ">
                <a href="https://nldevelop.com/en/">English</a>
              </li>
            
          
        
      </ul>
    </label>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">Сборка Golang-приложения в Docker</h1>
      <h2 class="date">August 8, 2021</h2>

      
    </header>

    <p>Допустим, мы написали <a href="https://github.com/nightlord189/test.mc">сервис</a> на Go. И теперь хотим его собрать в формате Docker-контейнера.</p>
<p><strong>1.</strong> Пишем простой Dockerfile:</p>
<div class="highlight"><pre class="chroma"><code class="language-Docker" data-lang="Docker"><span class="c"># Базовый образ, содержащий установленный Go</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> golang:alpine</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Копируем все файлы из корня проекта в образ</span><span class="err">
</span><span class="err"></span><span class="c"># Если нужно копировать не все, то можно это указать в файле .dockerignore</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Запускаем скачивание всех зависимостей (если у нас проект на модулях)</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Собираем бинарник</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o main .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Указываем, что приложению требуется 8080 порт</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8080</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Запускаем приложение</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;/main&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><p><strong>2.</strong> Собираем образ:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">docker build -t &lt;username&gt;/test.mc:latest .
</code></pre></div><p>В принципе, это уже рабочий вариант, который можно использовать.
Но если присмотреться, у него есть один недостаток - большой размер.</p>
<p>Почему так происходит?</p>
<p>Потому что при сборке по сути у нас выполняются следующие шаги:</p>
<ol>
<li>копируем исходники проекта</li>
<li>скачиваем все зависимости</li>
<li>собираем бинарный файл</li>
<li>запускаем собранный бинарник</li>
</ol>
<p>Неэффективность тут в том, что в контейнере у нас остаются исходники проекта и все сторонние зависимости. Хотя для работы они уже не нужны, т.к. Go собрал нам небольшой бинарный файл.</p>
<p>Как организовать сборку по-другому? Логичным решением видится копировать в конечный контейнер только бинарник, и, например, конфиг, чтобы размер контейнера был минимальным. Т.е. мы скачаем зависимости и соберем приложение в одном контейнере, а запускать его будем в другом, где даже не будет установленного Go (т.к. для запуска собранного приложения он уже не нужен).</p>
<p>Сделать это можно с помощью технологии <a href="https://habr.com/ru/post/349802/">multistage-билдов</a>.</p>
<p><strong>3.</strong> Модифицируем наш Dockerfile:</p>
<div class="highlight"><pre class="chroma"><code class="language-Docker" data-lang="Docker"><span class="c"># Базовый образ, содержащий установленный Go</span><span class="err">
</span><span class="err"></span><span class="c"># В этом образе мы будем собирать приложение</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> golang:alpine AS builder</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Указываем директорию, где будем работать с приложением в контейнере сборки</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /build</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Копируем все файлы из корня проекта в образ</span><span class="err">
</span><span class="err"></span><span class="c"># Если нужно копировать не все, то можно это указать в файле .dockerignore</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Запускаем скачивание всех зависимостей (если у нас проект на модулях)</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Собираем бинарник</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o main .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Указываем новый базовый образ, куда мы скопируем только итоги сборки - бинарник и конфиг</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Копируем в итоговый образ нужные файлы</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /build/main /<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /build/config.json /<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Указываем, что приложению требуется 8080 порт</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8080</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Запускаем приложение</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;/main&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><p><strong>4.</strong> Собираем образ аналогично пункту 2. Как можно увидеть, размер образа значительно уменьшился и составляет теперь несколько мегабайт.</p>
<p><strong>5.</strong> Еще одно возможное улучшение, которое можно дополнить - уменьшение скорости сборки. В тестовом сервисе всего две прямых зависимости, но в любом полноценном приложении их будет несколько десятков. Соответственно, выкачивать их все с нуля может занять несколько минут, а мы же хотим быстрый CI/CD и все дела :)</p>
<p>Для этого можно закэшировать основные (или все) зависимости приложения в отдельный базовый образ и собирать приложение уже в нем. Тогда т.к. скачивания зависимостей уже не будет, сборка пойдет быстрее.</p>
<p>Для создания такого базового образа можно использовать просто go.mod без самого приложения и отдельный Dockerfile:</p>
<p>go.mod:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">module &lt;username&gt;/golangweb

go 1.13

require (
	github.com/alecthomas/template v0.0.0-20190718012654-fb15b899a751
	github.com/gin-contrib/cors v1.3.1 // indirect
	github.com/gin-gonic/gin v1.7.2
	github.com/go-openapi/jsonreference v0.19.6 // indirect
	github.com/go-openapi/spec v0.20.3 // indirect
	github.com/go-openapi/swag v0.19.15 // indirect
	github.com/go-playground/validator/v10 v10.6.1 // indirect
	github.com/golang-jwt/jwt v3.2.1+incompatible // indirect
	github.com/golang/protobuf v1.5.2 // indirect
	github.com/google/uuid v1.2.0
	github.com/jackc/pgproto3/v2 v2.1.0 // indirect
	github.com/json-iterator/go v1.1.11 // indirect
	github.com/leodido/go-urn v1.2.1 // indirect
	github.com/lunixbochs/struc v0.0.0-20200707160740-784aaebc1d40 // indirect
	github.com/mailru/easyjson v0.7.7 // indirect
	github.com/mattn/go-isatty v0.0.13 // indirect
	github.com/nightlord189/firect v0.0.0-20210307220534-96b18afa5c05
	github.com/pkg/errors v0.9.1 // indirect
	github.com/swaggo/gin-swagger v1.3.0
	github.com/swaggo/swag v1.7.0
	github.com/ugorji/go v1.2.6 // indirect
	golang.org/x/crypto v0.0.0-20210616213533-5ff15b29337e // indirect
	golang.org/x/net v0.0.0-20210614182718-04defd469f4e // indirect
	golang.org/x/sys v0.0.0-20210616094352-59db8d763f22 // indirect
	golang.org/x/tools v0.1.3 // indirect
	google.golang.org/protobuf v1.26.0
	gorm.io/driver/postgres v1.1.0
	gorm.io/gorm v1.21.11
)
</code></pre></div><p>Dockerfile:</p>
<div class="highlight"><pre class="chroma"><code class="language-Docker" data-lang="Docker"><span class="k">FROM</span><span class="s"> golang:alpine</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk add build-base<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> go.mod .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span></code></pre></div><p>Далее собираем такой образ и пушим в DockerHub:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker login --u &lt;username&gt;
docker build -t &lt;username&gt;/golangweb:latest .
docker push &lt;username&gt;/golangweb:latest
</code></pre></div><p>И теперь в Dockerfile основного проекта остается поменять базовый образ с golang:alpine на свой:</p>
<div class="highlight"><pre class="chroma"><code class="language-Docker" data-lang="Docker"><span class="k">FROM</span><span class="s"> &lt;username&gt;/golangweb:latest AS builder</span><span class="err">
</span></code></pre></div><p>Если в базовом образе вдруг не окажется какой-то зависимости (например, вы ее недавно добавили и она специфична для конкретного приложения), то она скачается в процессе сборки.</p>
<p>Ссылки:</p>
<ul>
<li><a href="https://github.com/nightlord189/test.mc">Репозиторий с примером микросервиса на Go</a></li>
<li><a href="https://github.com/nightlord189/golangweb">Репозиторий с базовым образом</a></li>
<li><a href="https://hub.docker.com/repository/docker/nightlord189/golangweb">Собранный базовый образ на DockerHub</a></li>
</ul>

  </article>

  <br/>

  
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nldevelop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  
  
</section>

      </div>
      
    </main>

    

  <script src="/js/app.js"></script>
  
  </body>
</html>
